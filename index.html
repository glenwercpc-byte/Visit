/**
 * Google Apps Script for Church Visitation Log (시카고 언약장로교회)
 * * Instructions:
 * 1. Create a Google Sheet.
 * 2. Rename the first tab to "심방기록".
 * 3. Add headers in Row 1: [날짜, 시작시간, 종료시간, 대상자, 심방자, 요청자, 사유, 장소, 상담내용, 사후관리, 타임스탬프]
 * 4. Go to Extensions > Apps Script and paste this code.
 * 5. Deploy > New Deployment > Web App (Execute as: Me, Access: Anyone).
 */

const SHEET_NAME = "심방기록";

/**
 * POST handler: Receives data from the form and saves it to the sheet.
 */
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) throw new Error("Sheet '" + SHEET_NAME + "' not found.");
    
    const data = JSON.parse(e.postData.contents);
    
    // Maps the JSON keys from index.html to the spreadsheet columns
    sheet.appendRow([
      data.visitDate,    // Col A: 날짜
      data.startTime,    // Col B: 시작시간
      data.endTime,      // Col C: 종료시간
      data.targetName,   // Col D: 대상자
      data.visitorList,  // Col E: 심방자
      data.requestor,    // Col F: 요청자
      data.reason,       // Col G: 사유
      data.location,     // Col H: 장소
      data.details,      // Col I: 상담내용
      data.followUp,     // Col J: 사후관리
      new Date()         // Col K: 타임스탬프 (Record created at)
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({ "result": "success" }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * GET handler: Handles search queries and data retrieval.
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    
    // If no action is provided (e.g. opening the URL directly), show a status message or instructions
    if (!action) {
      return HtmlService.createHtmlOutput(
        "<html><body style='font-family: sans-serif; padding: 20px;'>" +
        "<h2>심방기록 API 시스템</h2>" +
        "<p>이 URL은 API 엔드포인트입니다. 웹 프로그램을 통해 접속하시거나 파라미터를 사용하세요.</p>" +
        "<ul>" +
        "<li>상태: <b>정상 작동 중</b></li>" +
        "<li>연결된 시트: " + (sheet ? SHEET_NAME : "시트를 찾을 수 없음") + "</li>" +
        "</ul>" +
        "</body></html>"
      );
    }

    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({ "error": "Sheet not found" }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // SEARCH LOGIC
    if (action === 'search') {
      const name = e.parameter.name;
      if (!name) {
        return ContentService.createTextOutput(JSON.stringify([]))
          .setMimeType(ContentService.MimeType.JSON);
      }

      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) {
        return ContentService.createTextOutput(JSON.stringify([]))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const headers = data.shift(); // Remove header row
      
      // Filter rows where index 3 (Target Name) contains the search string (case-insensitive)
      const results = data.filter(row => {
        return row[3] && row[3].toString().toLowerCase().includes(name.toLowerCase());
      }).map(row => {
        // Return object keys matching the fillForm() logic in index.html
        return {
          date: row[0],      // visitDate
          start: row[1],     // startTime
          end: row[2],       // endTime
          target: row[3],    // targetName
          visitors: row[4],  // visitorList
          req: row[5],       // requestor
          res: row[6],       // reason
          loc: row[7],       // location
          det: row[8],       // details
          fup: row[9]        // followUp
        };
      });
      
      return ContentService.createTextOutput(JSON.stringify(results))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Default error for unknown actions
    return ContentService.createTextOutput(JSON.stringify({ "error": "Invalid Action: " + action }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ "error": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
